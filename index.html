<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE電子秤 重量取得システム</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .connection-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
        }
        .status {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .connected {
            color: #4CAF50;
        }
        .disconnected {
            color: #f44336;
        }
        .button {
            background-color: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .button:hover {
            background-color: #1976D2;
        }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .weight-section {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
        }
        .weight-area {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
        }
        .weight-area h3 {
            margin-top: 0;
            color: #333;
        }
        .weight-display {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
            margin: 15px 0;
            min-height: 30px;
        }
        .get-weight-btn {
            background-color: #4CAF50;
            width: 100%;
        }
        .get-weight-btn:hover {
            background-color: #45a049;
        }
        .error-message {
            color: #f44336;
            font-size: 14px;
            margin-top: 10px;
        }
        .info-message {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BLE電子秤 重量取得システム</h1>
        
        <div class="connection-section">
            <div class="status" id="connectionStatus">状態: <span class="disconnected">未接続</span></div>
            <button class="button" id="connectBtn" onclick="connectToScale()">電子秤に接続</button>
            <button class="button" id="disconnectBtn" onclick="disconnectFromScale()" disabled>切断</button>
            <button class="button" id="simulationBtn" onclick="toggleSimulationMode()" style="background-color: #FF9800;">シミュレーション</button>
            <button class="button" id="monitoringBtn" onclick="toggleContinuousMonitoring()" style="background-color: #9C27B0;" disabled>連続監視開始</button>
            <div class="info-message" id="infoMessage">※ HTTPS接続でのみ動作します</div>
        </div>

        <div class="weight-section">
            <div class="weight-area">
                <h3>測定値1</h3>
                <button class="button get-weight-btn" id="getWeight1Btn" onclick="getWeight(1)" disabled>
                    重量取得1
                </button>
                <div class="weight-display" id="weightDisplay1">--.-- g</div>
                <div class="error-message" id="errorMessage1"></div>
            </div>
            
            <div class="weight-area">
                <h3>測定値2</h3>
                <button class="button get-weight-btn" id="getWeight2Btn" onclick="getWeight(2)" disabled>
                    重量取得2
                </button>
                <div class="weight-display" id="weightDisplay2">--.-- g</div>
                <div class="error-message" id="errorMessage2"></div>
            </div>
        </div>
    </div>

<script>
    // グローバル変数
    let bluetoothDevice = null;
    let bluetoothServer = null;
    let service = null;
    let readCharacteristic = null;
    let writeCharacteristic = null;
    let weight1 = null;
    let weight2 = null;
    let continuousMonitoring = false;
    let monitoringInterval = null;
    let receivedDataBuffer = null;
    let dataAccumulator = '';
    let currentRequestArea = 1;

    // SDKの仕様に基づく設定値
    const SERVICE_UUID = '5699d362-0c53-11e7-93ae-92361f002671';
    const READ_CHARACTERISTIC_UUID = '5699d646-0c53-11e7-93ae-92361f002671';
    const WRITE_CHARACTERISTIC_UUID = '5699d772-0c53-11e7-93ae-92361f002671';
    const DEVICE_NAME_PREFIX = 'A&D_BT_';

    // (シミュレーション関連の変数は変更なし)
    let simulationMode = false;
    const SIMULATION_WEIGHT_1 = 23.5;
    const SIMULATION_WEIGHT_2 = 154.8;
    
    // Web Bluetooth API対応チェック
    if (!navigator.bluetooth) {
        document.getElementById('infoMessage').textContent = 'このブラウザはWeb Bluetooth APIに対応していません';
        document.getElementById('connectBtn').disabled = true;
    }

    /**
     * 【修正点1】ページ読み込み時に自動接続を試みる
     *  - DOMContentLoadedイベント内で autoConnectOnLoad() を呼び出します。
     */
    document.addEventListener('DOMContentLoaded', () => {
        updateConnectionStatus(false);
        autoConnectOnLoad(); 
    });

    /**
     * 【新規追加】自動再接続処理
     *  - getDevices() を使って、以前に許可されたデバイスを取得します。
     *  - デバイスが見つかれば、ユーザー操作なしで接続を試みます。
     */
    async function autoConnectOnLoad() {
        try {
            const devices = await navigator.bluetooth.getDevices();
            if (devices.length > 0) {
                const device = devices[0]; // 最初に許可されたデバイスを取得
                console.log('以前に接続が許可されたデバイスが見つかりました:', device.name);
                updateInfoMessage(`以前接続した ${device.name} に再接続を試みます...`);
                // 取得したデバイス情報を使って接続処理を呼び出す
                await establishConnection(device);
            }
        } catch (error) {
            console.error('自動再接続エラー:', error);
            updateInfoMessage('自動再接続に失敗しました。');
        }
    }

    // 「電子秤に接続」ボタンが押されたときの処理
    async function connectToScale() {
        try {
            updateInfoMessage('接続するデバイスを選択してください...');
            
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: DEVICE_NAME_PREFIX }],
                optionalServices: [SERVICE_UUID]
            });
            
            console.log('ユーザーがデバイスを選択しました:', device.name);
            await establishConnection(device);
            
        } catch (error) {
            console.error('接続エラー:', error);
            updateInfoMessage('接続に失敗しました: ' + error.message);
            updateConnectionStatus(false);
        }
    }

    /**
     * 【修正点2】接続処理を共通化
     * - デバイスオブジェクトを引数に取り、接続から通知設定までを行う共通関数を作成。
     * - これにより、自動再接続とボタンによる接続の両方から呼び出せます。
     */
    async function establishConnection(device) {
        if (!device) return;

        console.log(`${device.name}への接続処理を開始します...`);
        bluetoothDevice = device; // グローバル変数にセット

        bluetoothServer = await bluetoothDevice.gatt.connect();
        service = await bluetoothServer.getPrimaryService(SERVICE_UUID);
        readCharacteristic = await service.getCharacteristic(READ_CHARACTERISTIC_UUID);
        writeCharacteristic = await service.getCharacteristic(WRITE_CHARACTERISTIC_UUID);
        
        await setupNotification();
        
        updateConnectionStatus(true);
        updateInfoMessage('接続成功: ' + bluetoothDevice.name);
    }
    
    // (以降の関数は大きな変更なし)

    // 通知の設定
    async function setupNotification() {
        if (readCharacteristic && readCharacteristic.properties.notify) {
            await readCharacteristic.startNotifications();
            readCharacteristic.addEventListener('characteristicvaluechanged', handleNotification);
            console.log('通知機能が有効化されました');
        }
    }

    // データ受信時の処理
    function handleNotification(event) {
        const value = event.target.value;
        const partialString = new TextDecoder().decode(value.buffer);
        dataAccumulator += partialString;
        
        while (dataAccumulator.includes('\r\n')) {
            const endIndex = dataAccumulator.indexOf('\r\n');
            const completeMessage = dataAccumulator.substring(0, endIndex);
            dataAccumulator = dataAccumulator.substring(endIndex + 2);

            try {
                const dataView = new DataView(new TextEncoder().encode(completeMessage).buffer);
                const weight = parseWeightData(dataView);
                console.log(`解析成功: ${weight}g (エリア${currentRequestArea}に表示)`);
                
                document.getElementById('weightDisplay' + currentRequestArea).textContent = weight.toFixed(2) + ' g';
                clearErrorMessage(currentRequestArea);

                if (currentRequestArea === 1) weight1 = weight;
                else weight2 = weight;

            } catch (error) {
                console.error(`解析エラー:`, error.message);
                showErrorMessage(currentRequestArea, `解析エラー: ${error.message}`);
            }
        }
    }

    // 電子秤からの切断
    async function disconnectFromScale() {
        try {
            stopContinuousMonitoring();
            dataAccumulator = '';
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                await bluetoothDevice.gatt.disconnect();
            }
            bluetoothDevice = null;
            updateConnectionStatus(false);
            updateInfoMessage('切断しました');
        } catch (error) {
            console.error('切断エラー:', error);
            updateInfoMessage('切断エラー: ' + error.message);
        }
    }

    // 重量取得
    async function getWeight(areaNumber) {
        try {
            clearErrorMessage(areaNumber);
            if (simulationMode) {
                const weight = areaNumber === 1 ? SIMULATION_WEIGHT_1 : SIMULATION_WEIGHT_2;
                document.getElementById('weightDisplay' + areaNumber).textContent = weight.toFixed(2) + ' g';
                return;
            }
            if (!writeCharacteristic) throw new Error('電子秤と接続されていません。');
            currentRequestArea = areaNumber;
            const command = new TextEncoder().encode('Q\r\n');
            await writeCharacteristic.writeValue(command);
            updateInfoMessage('データ受信待機中...');
        } catch (error) {
            console.error(`[エリア${areaNumber}] 重量取得エラー:`, error);
            if (error.message.includes('GATT')) updateConnectionStatus(false);
            showErrorMessage(areaNumber, 'コマンド送信エラー: ' + error.message);
        }
    }

    // 重量データの解析
    function parseWeightData(dataView) {
        const responseStr = new TextDecoder().decode(dataView.buffer).trim();
        console.log('解析対象:', `'${responseStr}'`);
        const header = responseStr.substring(0, 2);
        console.log('抽出ヘッダ:', `'${header}'`);

        if (header === 'ST') {
            const parts = responseStr.split(',');
            if (parts.length < 2) throw new Error('データ形式不正 (セパレータなし)');
            const weight = parseFloat(parts[1]);
            if (isNaN(weight)) throw new Error('重量の数値変換に失敗');
            return weight;
        } else if (header === 'US') {
            throw new Error('データ不安定');
        } else if (header === 'OL') {
            throw new Error('過重量');
        } else {
            throw new Error('未知のヘッダ');
        }
    }

    // --- 以下、変更のないヘルパー関数群 ---
    function toggleContinuousMonitoring(){if(continuousMonitoring)stopContinuousMonitoring();else startContinuousMonitoring();}
    function startContinuousMonitoring(){continuousMonitoring=!0;const e=document.getElementById("monitoringBtn");e.textContent="連続監視停止",e.style.backgroundColor="#f44336",monitoringInterval=setInterval(()=>{const e=(new Date).toISOString();receivedDataBuffer?console.log(`[${e}] 最新データあり`):console.log(`[${e}] データ待機中...`)},1e3),updateInfoMessage("連続監視を開始しました")}
    function stopContinuousMonitoring(){continuousMonitoring=!1;const e=document.getElementById("monitoringBtn");e.textContent="連続監視開始",e.style.backgroundColor="#9C27B0",monitoringInterval&&clearInterval(monitoringInterval),monitoringInterval=null,simulationMode||updateInfoMessage("連続監視を停止しました")}
    function toggleSimulationMode(){simulationMode=!simulationMode;const e=document.getElementById("simulationBtn"),t=document.getElementById("connectBtn"),n=document.getElementById("disconnectBtn");simulationMode?(e.textContent="シミュレーション中",e.style.backgroundColor="#4CAF50",updateConnectionStatus(!0),updateInfoMessage("シミュレーションモードが有効です"),t.disabled=!0,n.disabled=!0):(e.textContent="シミュレーション",e.style.backgroundColor="#FF9800",updateConnectionStatus(!1),updateInfoMessage("シミュレーションモードが無効です"),t.disabled=!1,n.disabled=!1,clearWeightDisplays(),stopContinuousMonitoring(),dataAccumulator="")}
    function clearWeightDisplays(){document.getElementById("weightDisplay1").textContent="--.-- g",document.getElementById("weightDisplay2").textContent="--.-- g",clearErrorMessage(1),clearErrorMessage(2)}
    function updateConnectionStatus(e){const t=document.getElementById("connectionStatus"),n=document.getElementById("connectBtn"),o=document.getElementById("disconnectBtn"),i=document.getElementById("getWeight1Btn"),a=document.getElementById("getWeight2Btn"),c=document.getElementById("monitoringBtn");e?(t.innerHTML=`状態: <span class="connected">${simulationMode?"シミュレーション接続":"接続済み"}</span>`,n.disabled=!0,o.disabled=!!simulationMode,i.disabled=!1,a.disabled=!1,c.disabled=!1):(t.innerHTML='状態: <span class="disconnected">未接続</span>',n.disabled=!!simulationMode,o.disabled=!0,i.disabled=!0,a.disabled=!0,c.disabled=!0,stopContinuousMonitoring())}
    function updateInfoMessage(e){document.getElementById("infoMessage").textContent=e}
    function showErrorMessage(e,t){document.getElementById("errorMessage"+e).textContent=t}
    function clearErrorMessage(e){document.getElementById("errorMessage"+e).textContent=""}
</script>
</body>
</html>




